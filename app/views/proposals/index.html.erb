<% page_title "#{@event.title} proposals" %>

<% cache_if(!logged_in?, "proposals_index_#{@event.id}") do %>
  <div>
    <% if accepting_proposals? %>
      <p>
        <%= simple_format @event.open_text %>
        <% if admin? %>
          <%= link_to "Edit", edit_manage_event_path(@event), :class => "editable" %>
        <% end %>
      </p>
      <div style="text-align: center">
        <div id="submit-a-talk" style="display: inline-block">
          <b class="rnd_top"><b class="rnd_b1"></b><b class="rnd_b2"></b><b class="rnd_b3"></b><b class="rnd_b4"></b></b>
          <div class="rnd_content">
            <%= link_to 'Submit a talk!', new_event_proposal_path(@event) %>
          </div>
          <b class="rnd_bottom"><b class="rnd_b4"></b><b class="rnd_b3"></b><b class="rnd_b2"></b><b class="rnd_b1"></b></b>
        </div>
      </div>
    <% else %>
      <p>
        <%= simple_format @event.closed_text %>
        <% if admin? %>
          <%= link_to "Edit", edit_manage_event_path(@event), :class => "editable" %>
        <% end %>
      </p>
    <% end %>
  </div>
  
  <% if proposal_excerpts? %>

      <% if @proposals.blank? %>
        <h4>&mdash; No proposals submitted yet &mdash;</h4>
      <% else %>
        <div>
          Sort by:
          <%= link_to "Title", event_proposals_path(@event, :sort => 'title') %>,
          <%= link_to "Track", event_proposals_path(@event, :sort => 'track') if event_tracks? %>,
          <%= link_to "Submission Date", event_proposals_path(@event, :sort => 'date') %>
        </div>
        <ul class='proposals'>
          <% for proposal in @proposals %>
          <li>
            <h3>
              <% if multiple_presenters? %>
                <%= link_to(h(proposal.title), proposal_path(proposal), :class => "title") %>
              <% else %>
                <%= link_to(h(proposal.presenter)+" &mdash; "+h(proposal.title), proposal_path(proposal), :class => "title") %>
              <% end %>
            </h3>
            
            <div class="excerpt">
              <%= h proposal.excerpt if proposal_excerpts? %>
            </div>
            
            <div class="speakers">
              <% if multiple_presenters? %>
                <%= proposal.users.map{|user| link_to(h(user.fullname), user_path(user))}.join(', ') %>
              <% end %>
            </div>
            
            <div class='metadata'>
              <div class='date'>
                <%= proposal.submitted_at.ergo{localtime.to_s} %>
              </div>
            
              <% if event_tracks? %>
              <div class='track block<%= " track-#{proposal.track.id}" if proposal.track %>'>
                <%= proposal.track.ergo.title || "- N/A -" %>
              </div>
              <% end %>              
            </div>
            
          </li>
          <% end %>
        </ul>
      <% end %>

  <% else %>
    <table id="proposal-listing">
      <% if @proposals.blank? %>
        <tr>
          <td colspan="2">
            <p class="empty-text">&mdash; No proposals submitted yet &mdash;</p>
          </td>
        </td>
      <% else %>
        <thead>
          <tr>
            <th width="100%">
              <% if multiple_presenters? %>
                Title
              <% else %>
                Speaker and title
              <% end %>
            </th>
  <% if event_tracks? %>
            <th>
              Track
            </th>
  <% end %>
            <th width="0">Submitted</th>
          </tr>
        </thead>
        <% date_cache = {} %>
        <% for proposal in @proposals %>
          <tr class="<%= cycle("even", "odd") %>" valign="top">
            <td width="100%">
              <p class="proposal">
                <% styling = proposal_excerpts? ? 'display: inline-block' : 'inline' %>
                <% if multiple_presenters? %>
                  <%= link_to(h(proposal.title), proposal, :class => "title", :style => styling) %>
                <% else %>
                  <%= link_to(h(proposal.presenter)+" &mdash; "+h(proposal.title), proposal, :class => "title", :style => styling) %>
                <% end %>

                <span class="excerpt">
                  <%= h proposal.excerpt if proposal_excerpts? %>
                </span>

                <p class="speakers">
                  <% if multiple_presenters? %>
                    <%= proposal.users.map{|user| link_to(h(user.fullname), user_path(user), :style => "display: inline")}.join(', ') %>
                  <% end %>
                </p>
              </p>
            </td>
  <% if event_tracks? %>
            <td>
              <p>
                <%= proposal.track.ergo.title || "- N/A -" %>
              </p>
            </td>
  <% end %>
            <td width="0" class="unbreakable">
              <p>
                <% date = proposal.submitted_at.ergo{localtime.to_s} %>
                <% if date_cache[date] %>
                  <!--
                  <span class="date-seen"><%= date %></span>
                  -->
                <% else %>
                  <% date_cache[date] = true %>
                  <span class="date-unseen"><%= date %></span>
                <% end %>
              </p>
            </td>
          </tr>
        <% end %>
      <% end %>
    </table>
  <% end %>
  
<% end %>
