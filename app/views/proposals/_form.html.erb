<p>
  <%= @event.open_text %>
  <% if admin? %>
    <%= link_to "Edit", edit_manage_event_path(@event), :class => :editable %>
  <% end %>
</p>

<div id="proposal-form" class="standard-form">
  <% form_for([@event, @proposal]) do |f| %>
    <table>
      <% unless error_messages_for(:proposal).blank? %>
        <thead>
          <tr>
            <td colspan="2">
              <%= error_messages_for :proposal %>
            </td>
          </tr>
        </thead>
      <% end %>
      <tbody>
<% if @proposal.new_record? and not logged_in? %>
        <tr>
          <td colspan="2">
            <h4>Login with OpenID</h4>
            <p><%= snippet_for :proposals_openid_text %></p>
          </td>
        </tr>
        <tr>
          <td class="label-cell">
            <%= image_tag "openid-icon.gif" %>
            OpenID
          </td>
          <td>
            <%= text_field_tag :openid_url, "" %>
            <%= submit_tag "Login", :id => "openid_login" %>
            <!-- BEGIN ID SELECTOR -->
            <script type="text/javascript">
              <!--
                  // Tell ID Selector which controls to affect
                  var idselector_input_id = "openid_url";
                  var idselector_target_id = "openid_login_wtf";
                -->
            </script>
            <%= javascript_include_tag "idselector" %>
            <!-- END ID SELECTOR -->
          </td>
        </tr>
<% end %>
<% if not user_profiles? and not multiple_presenters? %>
        <tr>
          <td colspan="2">
            <h4>About you</h4>
          </td>
        </tr>
        <tr>
          <td class="label-cell"><%= required_field %><%= f.label :presenter, "Name" %></td>
          <td><%= f.text_field :presenter %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= private_field %><%= required_field %><%= f.label :email, "Email" %></td>
          <td><%= f.text_field :email %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= f.label :affiliation, "Affiliation" %></td>
          <td><%= f.text_field :affiliation %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= f.label :website, "Website" %></td>
          <td><%= f.text_field :website %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= required_field %><%= f.label :biography, "Biography" %></td>
          <td><%= f.text_area :biography, :rows => 5 %></td>
        </tr>
<% else %>
        <tr>
          <td colspan="2">
            <h4>Speakers for this presentation</h4>
          </td>
        </tr>
        <tr>
          <td class="label-cell">
          </td>
          <td>
            <div id="manage-speakers">
              <%= render :partial => "proposals/manage_speakers" %>
            </div>
          </td>
        </tr>
<% end %>
        <tr>
          <td colspan="2">
            <h4>
<% if multiple_presenters? %>
              About this presentation
<% else %>
              About your presentation
<% end %>
            </h4>
          </td>
        </tr>
        <tr>
          <td class="label-cell"><%= required_field %><%= f.label :title, "Title" %></td>
          <td><%= f.text_field :title %></td>
        </tr>
<% if event_tracks? %>
          <tr>
            <td class="label-cell">
              <%= required_field %><%= f.label :track_id, "Track" %>
            </td>
            <td>
              <ul class='track-selector'>
              <% for track in @event.tracks %>
                <li>
                  <%= f.radio_button :track_id, track.id %>
                  <label for="proposal_track_id_<%= track.id %>">
                    <strong class="<%= track_css_class(track) %>"><%= track.title %></strong>
                    <% unless track.excerpt.blank? %>
                    <p class='excerpt'><%= track.excerpt %> <%= link_to "more&hellip;", track_path(track), :popup => true %></p>
                    <% end %>
                  </label>
                </li>
              <% end %>
              </ul>
            </td>
          </tr>
<% end %>
<% if event_session_types? %>
          <tr>
            <td class="label-cell">
              <%= required_field %><%= f.label :session_type_id, "Session Type" %>
            </td>
            <td>
              <%= f.collection_select :session_type_id, @event.session_types.find(:all), :id, :title, :prompt => "- Please select -" %>
              <%= link_to "What are this event's session types?", session_types_path, :popup => true %>
            </td>
          </tr>
<% end %>
<% if proposal_excerpts? %>
          <tr>
            <td class="label-cell"><%= required_field %><%= f.label :excerpt, "Excerpt" %></td>
            <td><%= f.text_area :excerpt, :rows => 2 %></td>
          </tr>
<% end %>
        <tr>
          <td class="label-cell"><%= required_field %><%= f.label :description, "Description" %></td>
          <td><%= f.text_area :description, :rows => 9 %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= f.label :tag_list, "Tags" %></td>
          <td><%= f.text_field :tag_list %></td>
        </tr>
        <tr>
          <td class="label-cell"><%= private_field %><%= f.label :note_to_organizers, "Note to organizers<br/ >(Optional)" %></td>
          <td><%= f.text_area :note_to_organizers, :rows => 3 %></td>
        </tr>
        <% if @proposal.new_record? %>
          <tr>
            <td class="label-cell"><%= required_field %><%= f.label :agreement, "Agreement" %></td>
            <td><%= f.check_box :agreement %>
              <%# TODO extract into snippet %>
              I understand that my talk will be recorded and posted online for the whole world to see. I know that <%= SETTINGS.organization %> is not the appropriate place for commercial promotion ("spam") of a product, service or solution and is not welcomed by the audience.
            </td>
          </tr>
        <% end %>
        <tr>
          <td>&nbsp;</td>
          <td>
            <div class="record-controls">
              <%= f.submit(@proposal.new_record? ? "Create" : "Update") %>
              <%= yield :form_controls %>
              <%= link_to("Cancel", (@proposal.new_record? ? event_proposals_path(@event) : proposal_path(@proposal)), :class => "cancelable") %>
            </div>
            <p style="margin-top: 2em; margin-bottom: 0">
              <%= required_field %> Fields marked with a red asterisk required and must be filled.
              <br />
              <%= private_field %> Fields marked with a green percent sign are private, visible only to you and the organizers.
            </p>
          </td>
        </tr>
      </tbody>
    </table>
  <% end %>
</div>

<% content_for :stylesheets do %>
  <%= stylesheet_link_tag 'jquery.autocomplete.css' %>
<% end %>

<% content_for :scripts do %>
  <%= javascript_include_tag \
    'jquery.bgiframe.min.js',
    'jquery.dimensions.min.js',
    'jquery.autocomplete.min.js' %>
<% end %>

<% content_for :javascript do %>
  <% path_record = @proposal.new_record? ? "new_record" : @proposal %>
  bind_manage_speakers_controls = function () {
    // Speaker extractor
    function extract_speaker_ids() {
      speaker_ids = [];
      $('.speaker_id').each(function (i, node) {
        speaker_ids.push(node['value'])
      });
      return speaker_ids;
    }
    function extract_speaker_frags() {
      return extract_speaker_ids().join(",")
    }

    // Remove speakers
    $('#manage-speakers a.remove-speaker').click(function (event) {
      event.preventDefault();
      target = $(event.target);
      speaker_id = target.attr('speaker_id');
      current_user_id = $('#current_user_id').attr('value');

      message = null;
      if (current_user_id == speaker_id) {
        message = "You will no longer be able to edit this proposal. Are you sure you want to remove yourself?";
      } else {
        message = target.attr('speaker_fullname') + " will no longer be able to edit this proposal. Are you sure you want to remove them?";
      }

      if (! confirm(message)) {
        return false;
      }

      target.removeClass('deletable');
      target.addClass('spinning');
      $.get(
        '<%= manage_proposal_speakers_path(path_record) %>?speakers='+extract_speaker_frags(), {
          'remove': speaker_id
        }, function(data) {
          $('#manage-speakers').html(data);
          bind_manage_speakers_controls();
          $("#add_speaker_selector").focus();
        }
      );
    });

    // Add speakers
    $("#add_speaker_selector").autocomplete("<%= other_proposal_speakers_path(path_record) %>?speakers="+extract_speaker_frags(), {
      delay: 200
    }).result(function (event, item) {
      // Item selected
      $.get(
        '<%= manage_proposal_speakers_path(path_record) %>?speakers='+extract_speaker_frags(), {
          'add': item[1]
        }, function(data) {
          $('#manage-speakers').html(data);
          bind_manage_speakers_controls();
          $("#add_speaker_selector").focus();
        }
      );
    });
  }

  $(document).ready(function() {
    bind_manage_speakers_controls();
  });
<% end %>
